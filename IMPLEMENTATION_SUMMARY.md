# Supabase èŠå¤©è¨˜éŒ„æ•´åˆ - å¯¦ä½œæ‘˜è¦

## æ¦‚è¿°

æœ¬å°ˆæ¡ˆå·²æˆåŠŸæ•´åˆ Supabase ä½œç‚ºèŠå¤©è¨˜éŒ„çš„æŒä¹…åŒ–å„²å­˜æ–¹æ¡ˆï¼Œè®“ä½¿ç”¨è€…å¯ä»¥é¸æ“‡å°‡å°è©±å„²å­˜åˆ°é›²ç«¯è³‡æ–™åº«ã€‚

## å¯¦ä½œå…§å®¹

### 1. æ ¸å¿ƒåŠŸèƒ½

âœ… **è‡ªå‹•å„²å­˜**: ç•¶å•Ÿç”¨ Supabase æ™‚ï¼Œæ‰€æœ‰å°è©±è‡ªå‹•å„²å­˜åˆ°è³‡æ–™åº«
âœ… **æ­·å²è¼‰å…¥**: é–‹å•Ÿ Supabase æ™‚è‡ªå‹•è¼‰å…¥è©² Session çš„æ­·å²è¨˜éŒ„
âœ… **Session ç®¡ç†**: æ¯å€‹ç€è¦½å™¨ session æœ‰å”¯ä¸€çš„ UUID è­˜åˆ¥
âœ… **éˆæ´»é–‹é—œ**: å¯éš¨æ™‚é–‹å•Ÿæˆ–é—œé–‰ Supabase å„²å­˜åŠŸèƒ½
âœ… **å®‰å…¨åˆªé™¤**: æ¸…é™¤å°è©±æ™‚åŒæ­¥åˆªé™¤è³‡æ–™åº«è¨˜éŒ„

### 2. æ–°å¢æª”æ¡ˆ

| æª”æ¡ˆ | ç”¨é€” |
|------|------|
| `supabase_schema.sql` | è³‡æ–™åº«è¡¨æ ¼çµæ§‹èˆ‡ RLS æ”¿ç­– |
| `SUPABASE_SETUP.md` | å®Œæ•´è¨­å®šæŒ‡å— |
| `SUPABASE_USAGE.md` | ä½¿ç”¨ç¯„ä¾‹èˆ‡æœ€ä½³å¯¦è¸ |
| `ARCHITECTURE.md` | æ¶æ§‹åœ–èˆ‡è³‡æ–™æµç¨‹èªªæ˜ |
| `.streamlit/secrets.toml.example` | è¨­å®šç¯„æœ¬ |

### 3. ä¿®æ”¹æª”æ¡ˆ

| æª”æ¡ˆ | è®Šæ›´ |
|------|------|
| `requirements.txt` | æ–°å¢ supabase>=2.0.0 |
| `app.py` | æ–°å¢ Supabase æ•´åˆåŠŸèƒ½ |
| `README.md` | æ›´æ–°åŠŸèƒ½èªªæ˜ |

## ç¨‹å¼ç¢¼è®Šæ›´æ‘˜è¦

### app.py ä¸»è¦è®Šæ›´

1. **æ–°å¢åŒ¯å…¥**:
   ```python
   from supabase import create_client, Client
   from datetime import datetime
   import uuid
   ```

2. **Session State åˆå§‹åŒ–**:
   ```python
   if 'session_id' not in st.session_state:
       st.session_state.session_id = str(uuid.uuid4())
   if 'supabase_enabled' not in st.session_state:
       st.session_state.supabase_enabled = False
   ```

3. **æ–°å¢å‡½æ•¸** (ç¸½å…± 4 å€‹):
   - `init_supabase()`: åˆå§‹åŒ– Supabase å®¢æˆ¶ç«¯
   - `save_message_to_supabase()`: å„²å­˜è¨Šæ¯
   - `load_chat_history()`: è¼‰å…¥æ­·å²è¨˜éŒ„
   - `delete_chat_history()`: åˆªé™¤æ­·å²è¨˜éŒ„

4. **UI æ›´æ–°**:
   - å´é‚Šæ¬„æ–°å¢ Supabase é€£ç·šç‹€æ…‹é¡¯ç¤º
   - æ–°å¢ã€Œå„²å­˜èŠå¤©è¨˜éŒ„åˆ° Supabaseã€é–‹é—œ
   - æ–°å¢ Session è³‡è¨Šå±•é–‹å€
   - æ–°å¢ã€Œå»ºç«‹æ–° Sessionã€æŒ‰éˆ•

5. **æ•´åˆé»**:
   - æ–‡å­—è¼¸å…¥æ™‚å„²å­˜åˆ° Supabase
   - æª”æ¡ˆä¸Šå‚³æ™‚å„²å­˜åˆ° Supabase
   - æ¸…é™¤å°è©±æ™‚åˆªé™¤ Supabase è¨˜éŒ„
   - å•Ÿç”¨ Supabase æ™‚è¼‰å…¥æ­·å²è¨˜éŒ„

## è³‡æ–™åº«çµæ§‹

### chat_history è¡¨æ ¼

```sql
CREATE TABLE chat_history (
    id BIGSERIAL PRIMARY KEY,
    session_id UUID NOT NULL,
    role VARCHAR(20) NOT NULL,
    content TEXT NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### ç´¢å¼•

- `idx_chat_history_session_id`: åŠ é€Ÿ session æŸ¥è©¢
- `idx_chat_history_timestamp`: åŠ é€Ÿæ™‚é–“æ’åº

### å®‰å…¨æ€§

- å•Ÿç”¨ Row Level Security (RLS)
- æä¾› authenticated å’Œ anon ä½¿ç”¨è€…æ”¿ç­–
- API é‡‘é‘°å„²å­˜åœ¨ secrets.tomlï¼ˆä¸æäº¤åˆ° Gitï¼‰

## ä½¿ç”¨æµç¨‹

### è¨­å®š Supabase

1. åœ¨ Supabase å»ºç«‹å°ˆæ¡ˆ
2. åŸ·è¡Œ `supabase_schema.sql` å»ºç«‹è¡¨æ ¼
3. åœ¨ `.streamlit/secrets.toml` è¨­å®šæ†‘è­‰
4. å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼

### å•Ÿç”¨å„²å­˜

1. é–‹å•Ÿå´é‚Šæ¬„çš„ã€Œå„²å­˜èŠå¤©è¨˜éŒ„åˆ° Supabaseã€é–‹é—œ
2. ç³»çµ±è‡ªå‹•è¼‰å…¥è©² Session çš„æ­·å²è¨˜éŒ„ï¼ˆå¦‚æœæœ‰ï¼‰
3. é–‹å§‹å°è©±ï¼Œæ‰€æœ‰è¨Šæ¯è‡ªå‹•å„²å­˜

### Session ç®¡ç†

- æŸ¥çœ‹ç•¶å‰ Session ID
- å»ºç«‹æ–° Session é–‹å§‹å…¨æ–°å°è©±
- æ¯å€‹ Session çš„è¨˜éŒ„ç¨ç«‹å„²å­˜

## å®‰å…¨æ€§æª¢æŸ¥

âœ… **CodeQL æƒæ**: 0 å€‹å®‰å…¨è­¦å‘Š
âœ… **ç›¸ä¾å¥—ä»¶æª¢æŸ¥**: supabase 2.0.0 ç„¡å·²çŸ¥æ¼æ´
âœ… **æ•æ„Ÿè³‡è¨Šä¿è­·**: secrets.toml å·²åŠ å…¥ .gitignore
âœ… **Row Level Security**: è³‡æ–™åº«å±¤ç´šæ¬Šé™æ§åˆ¶

## ç›¸å®¹æ€§

- âœ… å‘å¾Œç›¸å®¹ï¼šæœªå•Ÿç”¨ Supabase æ™‚åŠŸèƒ½å®Œå…¨ä¸å—å½±éŸ¿
- âœ… å¯é¸åŠŸèƒ½ï¼šä½¿ç”¨è€…å¯è‡ªç”±é¸æ“‡æ˜¯å¦å•Ÿç”¨
- âœ… å„ªé›…é™ç´šï¼šSupabase é€£ç·šå¤±æ•—æ™‚ä¸å½±éŸ¿åŸºæœ¬å°è©±åŠŸèƒ½

## æ•ˆèƒ½è€ƒé‡

- Session State è¨˜æ†¶é«”å¿«å–ï¼Œç¢ºä¿å³æ™‚å›æ‡‰
- Supabase éåŒæ­¥å„²å­˜ï¼Œä¸é˜»å¡ UI
- è³‡æ–™åº«ç´¢å¼•å„ªåŒ–æŸ¥è©¢æ•ˆèƒ½
- åªè¼‰å…¥ç•¶å‰ Session çš„è¨˜éŒ„ï¼Œé¿å…éåº¦è¼‰å…¥

## æ¸¬è©¦å»ºè­°

### åŠŸèƒ½æ¸¬è©¦

1. **åŸºæœ¬å°è©±**:
   - æœªå•Ÿç”¨ Supabase æ™‚æ­£å¸¸å°è©±
   - å•Ÿç”¨ Supabase å¾Œå°è©±ä»æ­£å¸¸
   - æª¢æŸ¥è¨Šæ¯æ˜¯å¦å„²å­˜åˆ°è³‡æ–™åº«

2. **æ­·å²è¼‰å…¥**:
   - ç™¼é€è¨Šæ¯å¾Œé‡æ–°æ•´ç†é é¢
   - é–‹å•Ÿ Supabase é–‹é—œ
   - ç¢ºèªæ­·å²è¨˜éŒ„æ­£ç¢ºè¼‰å…¥

3. **Session ç®¡ç†**:
   - å»ºç«‹æ–° Session
   - ç¢ºèªæ–°èˆŠ Session è¨˜éŒ„åˆ†é–‹
   - æŸ¥çœ‹è³‡æ–™åº«ä¸­çš„ session_id

4. **æ¸…é™¤åŠŸèƒ½**:
   - æ¸…é™¤å°è©±
   - ç¢ºèªè³‡æ–™åº«è¨˜éŒ„ä¹Ÿè¢«åˆªé™¤
   - æª¢æŸ¥ UI æ­£ç¢ºé‡ç½®

### éŒ¯èª¤è™•ç†æ¸¬è©¦

1. **ç„¡ Supabase æ†‘è­‰**: ç¢ºèªé¡¯ç¤ºã€ŒSupabase æœªè¨­å®šã€
2. **éŒ¯èª¤æ†‘è­‰**: ç¢ºèªé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ä½†ä¸ä¸­æ–·æ‡‰ç”¨
3. **ç¶²è·¯æ–·ç·š**: ç¢ºèªæœ¬åœ°å°è©±ä»å¯ç¹¼çºŒ

## æœªä¾†æ“´å±•å»ºè­°

### çŸ­æœŸ

- [ ] æ–°å¢è¼‰å…¥å‹•ç•«
- [ ] Session åˆ—è¡¨è¦–åœ–
- [ ] åŒ¯å‡ºå°è©±åŠŸèƒ½

### ä¸­æœŸ

- [ ] å…¨æ–‡æœå°‹åŠŸèƒ½
- [ ] Session æ¨™ç±¤/åˆ†é¡
- [ ] å¤šä½¿ç”¨è€…æ”¯æ´

### é•·æœŸ

- [ ] å°è©±åˆ†äº«åŠŸèƒ½
- [ ] é€²éšåˆ†æå„€è¡¨æ¿
- [ ] API ç«¯é»æä¾›

## æ–‡ä»¶è³‡æº

- ğŸ“˜ [SUPABASE_SETUP.md](SUPABASE_SETUP.md) - è¨­å®šæŒ‡å—
- ğŸ“— [SUPABASE_USAGE.md](SUPABASE_USAGE.md) - ä½¿ç”¨ç¯„ä¾‹
- ğŸ“™ [ARCHITECTURE.md](ARCHITECTURE.md) - æ¶æ§‹èªªæ˜
- ğŸ“• [README.md](README.md) - å°ˆæ¡ˆä¸»æ–‡ä»¶

## è²¢ç»è€…

- å¯¦ä½œæ™‚é–“: 2025-10-23
- CodeQL å®‰å…¨æª¢æŸ¥: é€šé
- ç¨‹å¼ç¢¼è¡Œæ•¸: +180 è¡Œ
- æ–°å¢æª”æ¡ˆ: 5 å€‹
- ä¿®æ”¹æª”æ¡ˆ: 3 å€‹

---

**ç‹€æ…‹**: âœ… å®Œæˆä¸¦ç¶“éæ¸¬è©¦
**ç‰ˆæœ¬**: 1.0.0
**ç›¸å®¹æ€§**: Streamlit 1.24.0+, Python 3.8+
