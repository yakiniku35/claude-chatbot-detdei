# UI 變更說明

本文件說明 Supabase 整合後的 UI 變更。

## 側邊欄變更

### 原本的側邊欄

```
┌─────────────────────────────┐
│ ⚠️ 系統未設定，請聯絡管理員  │  (若無 API key)
│ ✅ 系統就緒                 │  (若有 API key)
├─────────────────────────────┤
│ 📎 上傳檔案                 │
│ [選擇檔案...]               │
│ [📤 分析檔案]               │
├─────────────────────────────┤
│ 🌐 網路搜尋 [✓]            │
├─────────────────────────────┤
│ [🗑️ 清除對話]              │
└─────────────────────────────┘
```

### 新增 Supabase 整合後

```
┌─────────────────────────────┐
│ ⚠️ 系統未設定，請聯絡管理員  │  (若無 API key)
│ ✅ 系統就緒                 │  (若有 API key)
├─────────────────────────────┤
│ ✅ Supabase 已連線          │  ← 新增
│                             │
│ 💾 儲存聊天記錄到 Supabase  │  ← 新增
│    [✓] 開啟                 │  ← 新增（開關）
│                             │
│ 📝 Session 資訊 ▼           │  ← 新增（展開區）
│ ┌─────────────────────────┐│
│ │ Session ID: abc12345... ││  ← 新增
│ │ [🔄 建立新 Session]     ││  ← 新增
│ └─────────────────────────┘│
├─────────────────────────────┤
│ 📎 上傳檔案                 │
│ [選擇檔案...]               │
│ [📤 分析檔案]               │
├─────────────────────────────┤
│ 🌐 網路搜尋 [✓]            │
├─────────────────────────────┤
│ [🗑️ 清除對話]              │
└─────────────────────────────┘
```

### 若 Supabase 未設定

```
┌─────────────────────────────┐
│ ✅ 系統就緒                 │
├─────────────────────────────┤
│ ℹ️ Supabase 未設定          │  ← 顯示資訊訊息
├─────────────────────────────┤
│ 📎 上傳檔案                 │
│ ...                         │
└─────────────────────────────┘
```

## 功能流程圖

### 啟用 Supabase 儲存流程

```
使用者操作            系統行為              資料庫
─────────────────────────────────────────────────────
開啟開關          →  init_supabase()
                     └→ 檢查憑證
                        └→ 建立連線     →  連線到 Supabase
                           └→ load_history()
                              └→ SQL 查詢  →  SELECT * FROM 
                                                chat_history
                                             WHERE session_id = ?
                              ← 返回記錄   ←
                        ← 載入訊息
                     ← 更新 Session State
顯示歷史記錄      ←  重新渲染 UI
```

### 發送訊息流程（Supabase 啟用時）

```
使用者操作            系統行為              資料庫
─────────────────────────────────────────────────────
輸入訊息          →  新增到 Session State
                     └→ save_message()    →  INSERT INTO 
                                             chat_history
發送              →  呼叫 Groq API
                     ├→ 獲取 AI 回應
                     └→ 新增到 Session State
                        └→ save_message() →  INSERT INTO 
                                             chat_history
顯示回應          ←  重新渲染 UI
```

### 清除對話流程（Supabase 啟用時）

```
使用者操作            系統行為              資料庫
─────────────────────────────────────────────────────
點擊清除按鈕      →  delete_history()    →  DELETE FROM 
                                             chat_history
                                             WHERE session_id = ?
                     └→ 清除 Session State
顯示清除確認      ←  重新渲染 UI
```

## 訊息流向

### 無 Supabase（原本）

```
使用者輸入
    ↓
Session State (瀏覽器記憶體)
    ↓
Groq API
    ↓
Session State (瀏覽器記憶體)
    ↓
顯示給使用者
```

### 有 Supabase（新增）

```
使用者輸入
    ↓
Session State (瀏覽器記憶體) ────┐
    ↓                           ↓
Groq API                   Supabase DB
    ↓                           ↑
Session State (瀏覽器記憶體) ────┘
    ↓
顯示給使用者
```

## 狀態指示器

### Supabase 連線狀態

| 狀態 | 顯示 | 說明 |
|------|------|------|
| 已連線 | ✅ Supabase 已連線 | 憑證正確且連線成功 |
| 未設定 | ℹ️ Supabase 未設定 | secrets.toml 無 Supabase 設定 |
| 錯誤 | ❌ Supabase 初始化失敗: ... | 連線失敗或憑證錯誤 |

### 儲存狀態

| 狀態 | 開關位置 | 行為 |
|------|----------|------|
| 啟用 | ✓ 開啟 | 自動儲存所有訊息 |
| 停用 | ✗ 關閉 | 只使用 Session State |

### Session 資訊展開區

```
展開時顯示：
┌───────────────────────────┐
│ Session ID: abc12345...   │
│ [🔄 建立新 Session]       │
└───────────────────────────┘

收合時顯示：
📝 Session 資訊 ▶
```

## 錯誤處理 UI

### 儲存失敗

```
❌ 儲存訊息失敗: [錯誤訊息]
```
（顯示在主畫面頂部，紅色背景）

### 載入失敗

```
❌ 載入聊天記錄失敗: [錯誤訊息]
```
（顯示在主畫面頂部，紅色背景）

### 刪除失敗

```
❌ 刪除聊天記錄失敗: [錯誤訊息]
```
（顯示在主畫面頂部，紅色背景）

## 成功提示

### 載入歷史記錄成功

```
✅ 已載入 X 則訊息
```
（顯示在側邊欄，綠色背景，3秒後消失）

## 使用者體驗改進

### 開啟 Supabase 時的體驗

1. **即時反饋**: 開關切換時立即顯示載入狀態
2. **自動載入**: 不需手動操作即可恢復歷史對話
3. **無縫整合**: 啟用後對話體驗完全一致

### Session 管理體驗

1. **透明度**: 可以看到當前 Session ID
2. **靈活性**: 可以隨時建立新 Session
3. **隔離性**: 不同 Session 的對話完全分開

### 錯誤處理體驗

1. **優雅降級**: 儲存失敗不影響對話繼續
2. **明確訊息**: 錯誤訊息清楚說明問題
3. **本地備份**: Session State 始終保持最新狀態

## 響應式設計

所有新增的 UI 元件都支援：
- ✅ 桌面瀏覽器
- ✅ 平板裝置
- ✅ 手機瀏覽器

使用 Streamlit 的 `use_container_width=True` 確保按鈕自適應寬度。
