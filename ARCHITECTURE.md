# Supabase 整合架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                    使用者瀏覽器                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │           Streamlit 前端介面                        │    │
│  │                                                     │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐        │    │
│  │  │ 聊天輸入  │  │ 檔案上傳 │  │ 設定面板 │        │    │
│  │  └──────────┘  └──────────┘  └──────────┘        │    │
│  │                                                     │    │
│  │  ┌──────────────────────────────────────┐         │    │
│  │  │     Session State (瀏覽器記憶體)      │         │    │
│  │  │  • messages (對話記錄)                │         │    │
│  │  │  • session_id (UUID)                 │         │    │
│  │  │  • supabase_enabled (開關狀態)        │         │    │
│  │  └──────────────────────────────────────┘         │    │
│  └────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP/HTTPS
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Streamlit 後端 (app.py)                   │
│  ┌────────────────────────────────────────────────────┐    │
│  │                   核心功能模組                      │    │
│  │                                                     │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌──────────┐  │    │
│  │  │ Groq API    │  │ Supabase    │  │ DuckDuck │  │    │
│  │  │ 整合        │  │ 整合        │  │ Go 搜尋  │  │    │
│  │  │             │  │             │  │          │  │    │
│  │  │ • chat()    │  │ • init_    │  │ • search │  │    │
│  │  │             │  │   supabase()│  │   _web() │  │    │
│  │  │             │  │ • save_    │  │          │  │    │
│  │  │             │  │   message() │  │          │  │    │
│  │  │             │  │ • load_    │  │          │  │    │
│  │  │             │  │   history() │  │          │  │    │
│  │  │             │  │ • delete_  │  │          │  │    │
│  │  │             │  │   history() │  │          │  │    │
│  │  └─────────────┘  └─────────────┘  └──────────┘  │    │
│  └────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
        │                      │                    │
        │ API                  │ PostgreSQL REST    │ API
        │                      │ API                │
        ▼                      ▼                    ▼
┌──────────────┐    ┌────────────────────┐   ┌─────────────┐
│  Groq Cloud  │    │  Supabase Cloud    │   │ DuckDuckGo  │
│              │    │                    │   │             │
│  LLaMA 3.3   │    │  ┌──────────────┐ │   │  網路搜尋   │
│  70B Model   │    │  │ PostgreSQL   │ │   │             │
│              │    │  │              │ │   └─────────────┘
│              │    │  │ chat_history │ │
│              │    │  │   Table      │ │
│              │    │  │              │ │
│              │    │  │ • id         │ │
│              │    │  │ • session_id │ │
│              │    │  │ • role       │ │
│              │    │  │ • content    │ │
│              │    │  │ • timestamp  │ │
│              │    │  └──────────────┘ │
│              │    │                    │
│              │    │  Row Level Security│
│              │    │  (RLS Policies)   │
└──────────────┘    └────────────────────┘
```

## 資料流程

### 1. 使用者發送訊息

```
使用者輸入 → Session State → Groq API → AI 回應
                    ↓
        (如果 Supabase 啟用)
                    ↓
              save_message_to_supabase()
                    ↓
              Supabase API
                    ↓
            chat_history Table
```

### 2. 啟用 Supabase 儲存

```
使用者開啟開關 → init_supabase()
                      ↓
                檢查憑證 & 建立連線
                      ↓
              load_chat_history()
                      ↓
            Supabase API 查詢
                      ↓
            載入歷史記錄到 Session State
                      ↓
              更新 UI 顯示
```

### 3. 清除對話

```
使用者點擊清除 → (如果 Supabase 啟用)
                      ↓
               delete_chat_history()
                      ↓
            DELETE FROM chat_history
               WHERE session_id = ?
                      ↓
              清除 Session State
                      ↓
                重新整理 UI
```

## 安全機制

### 1. 認證層級

```
.streamlit/secrets.toml (本地)
         ↓
   環境變數保護
         ↓
   不提交到 Git (.gitignore)
```

### 2. 資料庫安全

```
Supabase Row Level Security (RLS)
         ↓
   政策定義 (supabase_schema.sql)
         ↓
   • 認證使用者政策
   • 匿名使用者政策
```

### 3. API 金鑰管理

```
secrets.toml → st.secrets → 僅在伺服器端使用
                           → 不暴露給客戶端
```

## Session 管理

```
新訪問 → 產生 UUID
           ↓
    儲存在 Session State
           ↓
      用於所有資料庫操作
           ↓
    每個 Session 獨立儲存
```

## 效能考量

- **Session State**: 記憶體內快取，快速存取
- **Supabase**: 持久化儲存，支援跨 Session 訪問
- **索引優化**: session_id 和 timestamp 欄位建立索引
- **查詢最佳化**: 只載入當前 Session 的記錄

## 可擴展性

```
目前架構
    ↓
單使用者 → 多使用者 (加入使用者認證)
    ↓
單 Session → 多 Session 管理
    ↓
基本功能 → 進階功能 (搜尋、匯出、分享)
```
